# Pingora Learning - Docker Compose Setup
#
# This sets up:
# - pingora-proxy: Your custom proxy on port 6188
# - upstream: A simple nginx server as the backend on port 8080
# - upstream-api: A second backend for load balancing experiments

services:
  # Your Pingora proxy
  pingora-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "6188:6188"
    depends_on:
      - upstream
    networks:
      - pingora-net
    environment:
      - RUST_LOG=info
      - UPSTREAM_ADDR=upstream:80

  # Primary upstream server (nginx serving static content)
  upstream:
    image: nginx:alpine
    volumes:
      - ./docker/upstream/html:/usr/share/nginx/html:ro
      - ./docker/upstream/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - pingora-net
    # Internal only - accessed via proxy

  # Secondary upstream for load balancing experiments
  upstream-api:
    image: nginx:alpine
    volumes:
      - ./docker/upstream-api/html:/usr/share/nginx/html:ro
      - ./docker/upstream-api/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - pingora-net

  # Optional: httpbin for API testing
  httpbin:
    image: kennethreitz/httpbin
    networks:
      - pingora-net

networks:
  pingora-net:
    driver: bridge
